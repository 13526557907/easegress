name: http-pipeline-orchestration-v2
kind: HTTPPipeline
# Built-in labels are `END` which can't be used by plugins.
flow:
  - plugin: aggregatorOne  
  - plugin: requestAdaptorTwo
  - plugin: aggregatorTwo
  - plugin: requestAdaptorThree
  - plugin: aggregatorThree
  - plugin: responseAdaptor

plugins:
  - apiproxys:
      - httpproxyname: http-proxy-agg
    kind: APIAggregator
    maxBodyBytes: 10240
    mergeResponse: true 
    name: aggregatorOne
    partialSucceed: true
  - name: requestAdaptorTwo
    kind: RequestAdaptor
    method: ""
    path: null
    header:
      del: []
      set:
        valid : "[[plugin.aggregatorOne.req.proto]]"
      add: {}
    body: "[[plugin.aggregatorOne.rsp.body]]"
  - apiproxys:
      - httpproxyname: http-proxy-agg-2
    kind: APIAggregator
    maxBodyBytes: 10240
    mergeResponse: true 
    name: aggregatorTwo
    partialSucceed: true
  - name: requestAdaptorThree
    kind: RequestAdaptor
    method: ""
    path: null
    header:
      del: []
      set:
      add: 
        adaptor-three: "[[plugin.aggregatorTwo.req.method]]"
    body: "[[plugin.aggregatorTwo.rsp.body]]"
  - apiproxys:
      - httpproxyname: http-proxy-agg-3
    kind: APIAggregator
    maxBodyBytes: 10240
    mergeResponse: true 
    name: aggregatorThree
    partialSucceed: true
  - name: responseAdaptor
    kind: ResponseAdaptor
    header:
      del: []
      set:
        Key-by-aggreone: "[[plugin.aggregatorOne.req.method]]"
      add:
        X-Proxy-Name-Three: "[[plugin.aggregatorThree.rsp.body.name]]"
        Rsp-adaptor: "[[plugin.aggregatorTwo.req.method]]"
    body: "{\"name1\": \"[[plugin.aggregatorOne.rsp.body.value]]\",\"name2\":\"[[plugin.aggregatorTwo.rsp.body.value]]\",\"name3\":\"[[plugin.aggregatorThree.rsp.body.reqfromabove]]\",\"req1\":\"[[plugin.aggregatorOne.req.body.aa]]\",\"req2\":\"[[plugin.aggregatorTwo.req.scheme]]\", \"req3\":\"[[plugin.aggregatorThree.req.proto]]\",\"req1host\":\"[[plugin.aggregatorOne.req.host]]\", \"req2path\":\"[[plugin.aggregatorTwo.req.path]]\"}"
      
