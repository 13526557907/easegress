language: go

go:
  - 1.9.x

## Build
before_install:
  ## EG project layout doesn't align with default layout
  ## So override the default layout generated by travis CI
  - cp -r ${TRAVIS_BUILD_DIR}/ ${HOME}/eg-repo
  - rm -rf ${GOPATH}/*
  - mv ${HOME}/eg-repo/* ${GOPATH}/
  - rm -rf ${HOME}/eg-repo
install:
  - cd ${GOPATH}/
  - make vendor_update
  - go get github.com/modocache/gover

script:
  - make build
  # test and generate code coverage result
  # go doesn't support creating combined coverage profiles for multiple packages, see #6909
  - go list -f '{{if len .TestGoFiles}}"go test -race -covermode=atomic -coverprofile={{.Dir}}/.coverprofile {{.ImportPath}}"{{end}}' ./... | xargs -L 1 sh -c
  - gover ./ ./gover.coverprofile

after_success:
  # repot code coverage result to covdecov.io
  - bash <(curl -s https://codecov.io/bash) -f gover.coverprofile -t ${CODECOV_IO_UPLOAD_TOKEN}
